# NXZ ファイル形式仕様書

バージョン: 1.0  
最終更新: 2024年7月6日

## 概要

NXZ (Next-Generation eXtensible Zip) は、SPE暗号化と高効率圧縮を組み合わせた次世代アーカイブ形式です。

## ファイル構造

### 基本構造

```
NXZファイル = [ヘッダ] + [メタデータ] + [データ部]
```

### 1. ヘッダ構造 (64バイト固定)

| オフセット | サイズ | フィールド | 説明 |
|-----------|--------|-----------|------|
| 0x00 | 4B | signature | ファイルシグネチャ "NXZ\0" |
| 0x04 | 2B | version | バージョン (0x0100 = v1.0) |
| 0x06 | 4B | header_size | ヘッダサイズ (64) |
| 0x0A | 4B | block_size | 圧縮ブロックサイズ |
| 0x0E | 8B | original_size | 元ファイルサイズ |
| 0x16 | 1B | compression_algorithm | 圧縮アルゴリズム |
| 0x17 | 1B | encryption_flag | 暗号化フラグ |
| 0x18 | 16B | reserved | 予約領域 |
| 0x28 | 4B | metadata_size | メタデータサイズ |
| 0x2C | 20B | padding | パディング |

### 2. 圧縮アルゴリズム識別子

| 値 | アルゴリズム | 説明 |
|----|-------------|------|
| 0 | Zstd | 高速展開重視 |
| 1 | LZMA2 | 高圧縮率重視 |
| 2 | Auto | 自動選択 |

### 3. 暗号化フラグ

| 値 | 暗号化方式 | 説明 |
|----|-----------|------|
| 0 | なし | 暗号化なし |
| 1 | AES-GCM | AES-256-GCM |
| 2 | XChaCha20 | XChaCha20-Poly1305 |

### 4. メタデータ構造

メタデータはbincode形式でシリアライズされた以下の構造体：

```rust
struct NxzMetadata {
    version: String,           // "1.0"
    created_at: u64,          // Unix timestamp
    original_size: u64,       // 元ファイルサイズ
    compressed_size: u64,     // 圧縮後サイズ
    compression_algorithm: CompressionAlgorithm,
    compression_level: u8,    // 圧縮レベル (1-9)
    is_encrypted: bool,       // 暗号化フラグ
    file_hash: Option<Vec<u8>>, // ファイルハッシュ (BLAKE3)
    original_filename: Option<String>, // 元ファイル名
}
```

### 5. データ部構造

#### 非暗号化の場合
```
データ部 = [SPE変換済み圧縮データ]
```

#### 暗号化の場合
```
データ部 = [Nonce(12B)] + [暗号化済みデータ] + [認証タグ(16B)]
```

## データ処理フロー

### 圧縮フロー

```
元データ
  ↓
SPE変換 (Structure-Preserving Encryption)
  ↓
圧縮 (Zstd/LZMA2)
  ↓
暗号化 (オプション: AES-GCM/XChaCha20)
  ↓
NXZファイル
```

### 展開フロー

```
NXZファイル
  ↓
復号 (暗号化されている場合)
  ↓
展開 (Zstd/LZMA2)
  ↓
SPE逆変換
  ↓
元データ
```

## SPE (Structure-Preserving Encryption)

SPEは独自の構造保持型暗号化技術で、以下の特徴があります：

1. **可逆変換**: 完全に元のデータに復元可能
2. **構造保持**: データの圧縮効率を損なわない
3. **難読化**: バイナリレベルでの解析を困難にする

### SPE変換手順

1. ブロック単位での並び替え (決定論的)
2. XORマスク適用
3. 構造保持パディング

## .nxz.sec 形式 (セキュリティ強化版)

.nxz.sec ファイルは、通常のNXZ形式に追加の暗号化層を適用したものです。

### 拡張構造

```
.nxz.sec = [NXZヘッダ] + [暗号化パラメータ] + [暗号化メタデータ] + [暗号化データ部]
```

### 暗号化パラメータ (32バイト)

| オフセット | サイズ | フィールド | 説明 |
|-----------|--------|-----------|------|
| 0x00 | 1B | cipher_type | 暗号化方式 |
| 0x01 | 1B | kdf_type | 鍵導出方式 |
| 0x02 | 4B | kdf_iterations | KDF反復回数 |
| 0x06 | 16B | salt | ソルト値 |
| 0x16 | 12B | nonce | ナンス値 |
| 0x22 | 2B | reserved | 予約 |

## 整合性検証

すべてのNXZファイルには以下の整合性検証機能があります：

1. **ヘッダチェックサム**: ヘッダ部の整合性
2. **データハッシュ**: BLAKE3による元データハッシュ
3. **暗号認証**: AES-GCM/ChaCha20-Poly1305の認証タグ

## エラーコード

| コード | 説明 |
|--------|------|
| 0x01 | 不正なファイルシグネチャ |
| 0x02 | サポートされていないバージョン |
| 0x03 | ヘッダ破損 |
| 0x04 | メタデータ読み込みエラー |
| 0x05 | 暗号化パスワード不正 |
| 0x06 | データ展開エラー |
| 0x07 | SPE逆変換エラー |
| 0x08 | 整合性チェック失敗 |

## 実装ガイドライン

### パフォーマンス最適化

1. **ブロック分割**: 256KB単位でのブロック処理
2. **並列処理**: 複数ブロックの同時処理
3. **メモリ効率**: ストリーミング処理の活用
4. **SSD最適化**: アライメントとシーケンシャルアクセス

### セキュリティ考慮事項

1. **鍵管理**: メモリ上での鍵の適切な消去
2. **タイミング攻撃**: 定数時間比較の実装
3. **サイドチャネル**: キャッシュタイミング対策
4. **ランダム性**: 暗号学的に安全な乱数生成

## 互換性

### バージョン互換性

- v1.0: 基本NXZ形式
- v1.1: 拡張メタデータサポート (予定)
- v2.0: PQ暗号サポート (予定)

### プラットフォーム

- Windows (x64, ARM64)
- macOS (Intel, Apple Silicon)
- Linux (x64, ARM64)

## 参考実装

リファレンス実装はRustで提供され、以下のcrateを使用しています：

- `zstd`: Zstd圧縮
- `xz2`: LZMA2圧縮
- `aes-gcm`: AES-GCM暗号化
- `chacha20poly1305`: ChaCha20-Poly1305暗号化
- `blake3`: ハッシュ計算
- `pbkdf2`: 鍵導出

---

この仕様書は、NXZipプロジェクトの一部として提供されています。
最新の仕様については、公式リポジトリを参照してください。
